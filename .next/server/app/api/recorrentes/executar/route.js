(()=>{var e={};e.id=108,e.ids=[108],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5792:(e,t,r)=>{"use strict";r.r(t),r.d(t,{GET:()=>n,POST:()=>n,authOptions:()=>o.N});var a=r(19854),s=r.n(a),o=r(12909);let n=s()(o.N)},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,r)=>{"use strict";r.d(t,{N:()=>i});var a=r(13581),s=r(94747),o=r(85663);let n=[{id:"1",email:"teste@teste.com",nome:"Usu\xe1rio Teste",senha:"$2b$10$g92IzJGsugx/Olm/4WqHJO3SHiJb9vqMiXSOVEfG4yD0Yy1znTN2q"},{id:"2",email:"admin@admin.com",nome:"Administrador",senha:"$2b$10$g92IzJGsugx/Olm/4WqHJO3SHiJb9vqMiXSOVEfG4yD0Yy1znTN2q"}],i={providers:[(0,a.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let t=await s.z.usuario.findUnique({where:{email:e.email}});if(t&&await o.Ay.compare(e.password,t.senha))return{id:t.id,email:t.email,name:t.nome||""}}catch(r){console.log("‚ö†Ô∏è Erro de conex\xe3o com banco, usando usu\xe1rios tempor\xe1rios:",r);let t=n.find(t=>t.email===e.email);if(t&&await o.Ay.compare(e.password,t.senha))return{id:t.id,email:t.email,name:t.nome}}return null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.id),e)},pages:{signIn:"/login"}}},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45301:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>x,serverHooks:()=>f,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>g,POST:()=>d});var s=r(96559),o=r(48088),n=r(37719),i=r(32190),c=r(94747),l=r(19854),u=r(5792);async function d(e){try{let t=await (0,l.getServerSession)(u.authOptions);if(!t?.user?.email)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let r=await c.z.usuario.findUnique({where:{email:t.user.email}});if(!r)return i.NextResponse.json({error:"Usu\xe1rio n\xe3o encontrado"},{status:404});let{recorrenteId:a}=await e.json().catch(()=>({})),s=new Date;console.log(`üïê Data/hora atual: ${s.toISOString()}`);let o={userId:r.id,isActive:!0,dataInicio:{lte:s},OR:[{dataFim:null},{dataFim:{gte:s}}]};a?(o.id=a,console.log(`üéØ Execu\xe7\xe3o individual para recorrente ID: ${a}`)):console.log(`üîÑ Execu\xe7\xe3o em lote para todas as recorrentes`),console.log("\uD83D\uDD0D Filtros para busca de recorrentes:",JSON.stringify(o,null,2));let n=await c.z.transacaoRecorrente.findMany({where:o,include:{transacoes:{orderBy:{data:"desc"},take:1}}});console.log(`üìã Recorrentes ativas encontradas: ${n.length}`),n.forEach((e,t)=>{console.log(`  ${t+1}. ${e.descricao} - ${e.tipo} - R$ ${e.valor} - Frequ\xeancia: ${e.frequencia}`)});let d=[],g=[],x=[];for(let e of n){console.log(`
üîÑ Processando: ${e.descricao}`);try{let t=new Date(e.dataInicio);if(e.transacoes.length>0){let r=e.transacoes[0];console.log(`  üìÖ \xdaltima transa\xe7\xe3o encontrada: ${r.data.toISOString()}`),t=p(r.data,e.frequencia)}else console.log(`  ‚ÑπÔ∏è Nenhuma transa\xe7\xe3o gerada ainda, usando data inicial: ${t.toISOString()}`);if(console.log(`  ‚û°Ô∏è Pr\xf3xima execu\xe7\xe3o calculada: ${t.toISOString()}`),t<=s){console.log(`  ‚ö†Ô∏è Pendente: Pr\xf3xima execu\xe7\xe3o (${t.toISOString()}) \xe9 anterior a agora (${s.toISOString()})`);let a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1);console.log(`  üîç Verificando transa\xe7\xf5es existentes entre ${a.toISOString()} e ${o.toISOString()}`);let n=await c.z.transacao.findFirst({where:{userId:r.id,...{transacaoRecorrenteId:e.id},data:{gte:a,lt:o}}});if(n)console.log(`  ‚ö†Ô∏è Transa\xe7\xe3o j\xe1 existe para esta data: ID ${n.id}`);else try{let a=await c.z.transacao.create({data:{userId:r.id,categoriaId:e.categoriaId,tipo:e.tipo,valor:e.valor,descricao:`[RECORRENTE] ${e.descricao}`,data:t,transacaoRecorrenteId:e.id,isRecorrente:!0,tags:[],anexos:[]}});g.push(a)}catch(t){x.push({recorrenteId:e.id,descricao:e.descricao,erro:t.message,stack:void 0})}d.push({...e,proximaExecucao:t,ultimaExecucao:e.transacoes[0]?.data||null}),console.log(`  üìå Adicionada \xe0 lista de pendentes`)}else console.log(`  ‚úÖ Em dia - pr\xf3xima execu\xe7\xe3o: ${t.toISOString()}`)}catch(t){console.error(`  ‚ùå Erro ao processar recorrente ${e.id}:`,t),x.push({recorrenteId:e.id,descricao:e.descricao,erro:t.message,stack:void 0})}}console.log(`
üìä Resumo da execu\xe7\xe3o:`),console.log(`  ‚úÖ Transa\xe7\xf5es criadas: ${g.length}`),console.log(`  ‚ùå Erros: ${x.length}`),console.log(`  ‚ö†Ô∏è Pendentes: ${d.length}`);let m=`${g.length} transa\xe7\xf5es criadas${x.length>0?`, ${x.length} erros`:""}`;return i.NextResponse.json({success:!0,message:m,transacoesCriadas:g.length,erros:x.length,detalhes:{transacoes:g,erros:x}})}catch(e){return console.error("Erro ao executar transa\xe7\xf5es recorrentes:",e),i.NextResponse.json({error:"Erro interno do servidor",details:e.message},{status:500})}}function p(e,t){let r=new Date(e),a=t.toUpperCase();switch(console.log(`  üìÖ Calculando pr\xf3xima data a partir de ${e.toISOString()} com frequ\xeancia ${a}`),a){case"DIARIA":case"DIARIO":r.setDate(r.getDate()+1);break;case"SEMANAL":r.setDate(r.getDate()+7);break;case"QUINZENAL":r.setDate(r.getDate()+15);break;case"MENSAL":r.setMonth(r.getMonth()+1);break;case"BIMESTRAL":r.setMonth(r.getMonth()+2);break;case"TRIMESTRAL":r.setMonth(r.getMonth()+3);break;case"SEMESTRAL":r.setMonth(r.getMonth()+6);break;case"ANUAL":r.setFullYear(r.getFullYear()+1);break;default:console.warn(`Frequ\xeancia n\xe3o reconhecida: ${t}, usando MENSAL como padr\xe3o`),r.setMonth(r.getMonth()+1)}return console.log(`  üìÖ Nova data calculada: ${r.toISOString()}`),r}async function g(e){try{let e=await (0,l.getServerSession)(u.authOptions);if(!e?.user?.email)return i.NextResponse.json({error:"N\xe3o autorizado"},{status:401});let t=await c.z.usuario.findUnique({where:{email:e.user.email}});if(!t)return i.NextResponse.json({error:"Usu\xe1rio n\xe3o encontrado"},{status:404});let r=new Date,a=await c.z.transacaoRecorrente.findMany({where:{userId:t.id,isActive:!0,dataInicio:{lte:r},OR:[{dataFim:null},{dataFim:{gte:r}}]},include:{categoria:!0,transacoes:{orderBy:{data:"desc"},take:1}}}),s=[];for(let e of a){let t=new Date(e.dataInicio);if(e.transacoes.length>0){let r=e.transacoes[0];t=p(r.data,e.frequencia)}t<=r&&s.push({...e,proximaExecucao:t,ultimaExecucao:e.transacoes[0]?.data||null})}return i.NextResponse.json({pendentes:s,totalPendentes:s.length,totalExecucoesPendentes:s.length})}catch(e){return console.error("Erro ao verificar transa\xe7\xf5es pendentes:",e),i.NextResponse.json({error:"Erro interno do servidor",details:e.message},{status:500})}}let x=new s.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/recorrentes/executar/route",pathname:"/api/recorrentes/executar",filename:"route",bundlePath:"app/api/recorrentes/executar/route"},resolvedPagePath:"C:\\Users\\Alan Ara\xfajo\\Documents\\Meu bolso\\src\\app\\api\\recorrentes\\executar\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:m,workUnitAsyncStorage:h,serverHooks:f}=x;function w(){return(0,n.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:h})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},94747:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});let a=require("@prisma/client"),s=global.prisma||new a.PrismaClient},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[243,580,663,412],()=>r(45301));module.exports=a})();